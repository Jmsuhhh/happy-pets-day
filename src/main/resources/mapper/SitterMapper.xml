<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.happypetsday.mapper.SitterMapper">

<!--    시터-->
    <update id="updateSitter">
        UPDATE TBL_SITTER
        SET SITTER_HEADER = #{sitterHeader}, SITTER_INTRODUCTION = #{sitterIntroduction}
        WHERE USER_NUMBER = #{userNumber}
    </update>

    <select id="selectSitterNumber" resultType="long">
        SELECT SITTER_NUMBER FROM TBL_SITTER
        WHERE USER_NUMBER = #{userNumber}
    </select>



<!--    시터 지원 -->
    <select id="selectApplyNumber" resultType="long">
        SELECT APPLY_NUMBER FROM TBL_SITTER_APPLY
        WHERE USER_NUMBER = #{userNumber}
    </select>

    <insert id="apply">
        <selectKey keyProperty="applyNumber" order="BEFORE" resultType="long">
            SELECT SEQ_SITTER_APPLY.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_SITTER_APPLY (APPLY_NUMBER, APPLY_CONTENT, APPLY_DATE, USER_NUMBER)
        VALUES (#{applyNumber}, #{applyContent}, SYSDATE, #{userNumber})
    </insert>



<!--    시터 필드-->
    <insert id="insertField">
        INSERT INTO TBL_SITTER_FIELD (SITTER_FIELD_NUMBER, PET_FIELD_NAME, USER_NUMBER)
        VALUES (SEQ_SITTER_FIELD.NEXTVAL, #{petFieldName}, #{userNumber})
    </insert>

    <delete id="deleteField">
        DELETE FROM TBL_SITTER_FIELD
        WHERE USER_NUMBER = #{userNumber}
    </delete>



<!--    시터 리스트-->
    <select id="selectList" resultType="sitterListVo">
        SELECT U.USER_NAME,
               S.SITTER_NUMBER,
               S.SITTER_HEADER,
               sf.SITTER_FILE_FILE_NAME,
               sf.SITTER_FILE_UPLOAD_PATH,
               sf.SITTER_FILE_UUID,
               spf.SITTER_PROFILE_FILE_NAME,
               spf.SITTER_PROFILE_UPLOAD_PATH,
               spf.SITTER_PROFILE_UUID,
               COUNT(sr.REVIEW_NUMBER),
               AVG(sr.REVIEW_SCORE)
        FROM TBL_SITTER s
                 JOIN TBL_USER u ON S.USER_NUMBER = U.USER_NUMBER
                 LEFT OUTER JOIN (select SITTER_NUMBER, SITTER_FILE_UPLOAD_PATH, SITTER_FILE_UUID, SITTER_FILE_FILE_NAME, SITTER_FILE_NUMBER FROM
            (SELECT SITTER_NUMBER, SITTER_FILE_UPLOAD_PATH, SITTER_FILE_UUID, SITTER_FILE_FILE_NAME, SITTER_FILE_NUMBER,
                    RANK() OVER (PARTITION BY SITTER_NUMBER ORDER BY SITTER_FILE_NUMBER) RK
             from TBL_SITTER_FILE sf)
                                  WHERE RK = 1) sf ON s.SITTER_NUMBER = sf.SITTER_NUMBER
                 LEFT OUTER JOIN TBL_SITTER_PROFILE_FILE spf ON s.SITTER_NUMBER = spf.SITTER_NUMBER
                 LEFT OUTER JOIN TBL_SITTER_REVIEW sr ON s.SITTER_NUMBER = sr.SITTER_NUMBER
        GROUP BY U.USER_NAME,
                 S.SITTER_NUMBER,
                 S.SITTER_HEADER,
                 sf.SITTER_FILE_FILE_NAME,
                 sf.SITTER_FILE_UPLOAD_PATH,
                 sf.SITTER_FILE_UUID,
                 spf.SITTER_PROFILE_FILE_NAME,
                 spf.SITTER_PROFILE_UPLOAD_PATH,
                 spf.SITTER_PROFILE_UUID
    </select>

    <select id="countSitter" resultType="int">
        SELECT COUNT(S.SITTER_NUMBER) FROM TBL_USER U
                                               JOIN TBL_SITTER S
                                                    ON U.USER_NUMBER = S.USER_NUMBER
        WHERE U.USER_NUMBER=#{userNumber}
    </select>


<!--    시터 프로필-->
    <select id="selectSitterProfile" resultType="sitterListVo">
        SELECT  sf.APPLY_FILE_TITLE, sf.APPLY_FILE_NAME, sf.APPLY_FILE_UUID
        FROM TBL_SITTER s
                 LEFT OUTER JOIN TBL_SITTER_APPLY_LICENSE_FILE sf
                                 ON s.USER_NUMBER = sf.USER_NUMBER
        WHERE s.SITTER_NUMBER = #{sitterNumber}
    </select>

<!--    <select id="selectSitterNumber" resultType="long">-->
<!--        SELECT SITTER_NUMBER,USER_NUMBER FROM TBL_SITTER-->
<!--        WHERE SITTER_NUMBER = #{sitterNumber}-->
<!--    </select>-->
</mapper>